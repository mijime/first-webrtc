<script type=text/javascript>
var label = 'MyLabel';

// Browser によって名前違う
var RTCPeerConnection =
  RTCPeerConnection ||
  webkitRTCPeerConnection ||
  mozRTCPeerConnection;

var iceServers = [{url: 'stun:stun.l.google.com:19302'}];
var optional = [{RtpDataChannels: true}];
var mediaConstraints = {
  optional: [],
  mandatory: {
    OfferToReceiveAudio: false,
    OfferToReceiveVideo: false,
  },
};

var offer = new RTCPeerConnection({iceServers}, {optional});
var answer = new RTCPeerConnection({iceServers}, {optional});

setIceCandidate(offer, answer);
setIceCandidate(answer, offer);

var offerDC = createDataChannel(offer);

var p = new Promise(r => offer.createOffer(r))
  .then(sdp => {
    offer.setLocalDescription(sdp);
    return sdp;
  }).then(sdp => {
    answer.setRemoteDescription(sdp);
    return new Promise(r => answer.createAnswer(r));
  }).then(sdp => {
    answer.setLocalDescription(sdp);
    offer.setRemoteDescription(sdp);
  });

function setIceCandidate (spc, dpc) {
  spc.onicecandidate = function (e) {
    if (!dpc || !e || !e.candidate)
      return;
    dpc.addIceCandidate(e.candidate);
  }
}

function createDataChannel (pc) {
  var dc = pc.createDataChannel(label, {
    reliable: false,
  });

  dc.onerror = function (e) {console.log('[E]', e)}
  dc.onmessage = function (e) {console.log('[I] message', e)}
  dc.onopen = function () {console.log('[I] open')}
  dc.onclose = function () {console.log('[I] close')}

  return dc;
}
</script>
