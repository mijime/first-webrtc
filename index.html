<script type=text/javascript>
console.log('hello world');

var label = 'MyLabel';

// Browser によって名前違う
var RTCPeerConnection =
  RTCPeerConnection ||
  webkitRTCPeerConnection ||
  mozRTCPeerConnection;

var pc = new RTCPeerConnection(null);

function sendOffer () {
  return new Promise(resolve => {
    return pc.createOffer(resolve)
  }).then(sdp => {
    pc.setLocalDescription(sdp);
    return fetch('/api', {
      method: 'POST',
      body: JSON.stringify(sdp),
    });
  });
}

function receiveAnswer () {
  return fetch('/api')
    .then(res => res.json())
    .then(sdp => {
      pc.setRemoteDescription(sdp);
    });
}

function sendAnswer () {
  return fetch('/api')
    .then(res => res.json())
    .then(sdp => {
      pc.setRemoteDescription(sdp);
      return new Promise((resolve, reject) => {
        pc.createAnswer(resolve);
      });
    }).then(sdp => {
      pc.setLocalDescription(sdp);
      return fetch('/api', {
        method: 'POST',
        body: JSON.stringify(sdp),
      });
    });
}

var dc = pc.createDataChannel(label, {});

dc.onerror = function (e) {
  console.log('[E]', e);
}

dc.onmessage = function (e) {
  console.log('[I] message', e);
}

dc.onopen = function () {
  dc.send('[I] open');
}

dc.onclose = function () {
  console.log('[I] close');
}
</script>
